<html>
  <head>
    <title>ðŸ•¶</title>
    <link href="https://fonts.googleapis.com/css?family=Passion+One" rel="stylesheet">
    <style> 
      body {
        align-items: center;
        display: flex;
        height: 100vh;
        justify-content: center;
        margin: 0;
        transition: background .2s;
      }
      
      p.show {
        animation: appear 1s forwards;
        color: rgba(0, 0, 0, .75);
        font: 10vw/.95 'Passion One', cursive;
        margin: 5vh 5vw;
        text-align: center;
        text-transform: uppercase;
      }
      
      @keyframes appear {
        from { transform: translateY(-10px); opacity: 0; }
        to { transform: translateY(0px); opacity: 1; }
      }
    </style>
  </head>
  <body>
    <p></p>
    <script>
      const REFRESH_INTERVAL_MS = 5 * 1000;
      const ISSUES_API = 'https://api.github.com/repos/jtangelder/jtangelder.github.io/issues';
      const COLORS = ['#d11141', '#00b159', '#00aedb', '#f37735', '#ffc425'];
      
      function setRandomBackground() {
        const color = COLORS[Math.floor(COLORS.length * Math.random())];
        document.body.style.background = color;
      }
      
      function getRecentMessage() {
        return fetch(ISSUES_API, {cache: 'no-cache'})
          .then(response => response.json())
          .then(issues => {
            return issues.find(issue =>
                issue.author_association === 'OWNER' && 
                issue.state === 'open' &&
                issue.title.startsWith('#blog')
            );
          })
          .then(issue => { 
            if(!issue) { 
              throw new Error('No message found.');
            }
            return issue.body;
          });
      }
      
      function showMessage(message) {
        const element = document.querySelector('p');
        if (element.textContent !== message) {
          element.textContent = message;

          element.classList.remove('show');
          element.getBoundingClientRect(); // Repaint to retrigger the CSS animation.
          element.classList.add('show');

          setRandomBackground();
        }
      }
      
      function showRecentMessage() {
        return new Promise((resolve, reject) => {
          document.visibilityState === 'visible' ? 
              resolve() : 
              reject(new Error('Page is hidden.'));
        })
          .then(getRecentMessage)
          .then(showMessage)
          .catch(err => console.log(err.message))
          .finally(() => setTimeout(showRecentMessage, REFRESH_INTERVAL_MS));
      }
      
      showRecentMessage();
    </script>
  </body>
</html>
